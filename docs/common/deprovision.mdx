# Deprovision

To destroy your kubefirst cluster, complete the following steps.

## Prerequisites

### kubefirst CLI

If you are coming from a cloud marketplace, and didn't use the kubefirst CLI, you will need to install it first.

```shell
brew install kubefirst/tools/kubefirst
```

More information in the [installation steps from our documentation](https://docs.kubefirst.io/next/aws/quick-start/install/cli#local-prerequisites).

### Kubernetes CLI

If not already done, you will need `kubectl` to retrieve some information from your cluster.

```shell
brew install kubectl
```

More information in the [Kubernetes documentation](https://kubernetes.io/docs/tasks/tools/#kubectl).

### Clouds CLIs

If the command-line tool for the chosen cloud provider is not installed, consult the following documentation for installation steps:

<!--tabs-->

#### AWS

```shell
brew install awscli
```

More information in the [AWS documentation](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html).

#### Civo

```shell
brew tap civo/tools
brew install civo
```

More information in the [Civo documentation](https://www.civo.com/docs/overview/civo-cli).

#### DigitalOcean

```shell
brew install doctl
```

More information in the [DigitalOcean documentation](https://docs.digitalocean.com/reference/doctl/).

#### Google Cloud

```shell
brew install google-cloud-sdk
gcloud components install gke-gcloud-auth-plugin
```

More information in the [Google Cloud documentation](https://cloud.google.com/sdk).

#### Vultr

```shell
brew tap vultr/vultr-cli
brew install vultr-cli
```

More information in the [Vultr documentation](https://github.com/vultr/vultr-cli).

<!--/tabs-->

### Terraform CLI

To complete the deprovisioning process, you also need to install the Terraform CLI.

```shell
brew install terraform
```

More information in the [Terraform documentation](https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli).

### Obtain the kubeconfig

Before continuing, use the command-line tool for the chosen cloud provider to get the `kubeconfig` for your cluster (replace `<my-cluster>` with your cluster name):

<!--tabs-->

# AWS

```shell
aws eks update-kubeconfig --name <my-cluster> --region <my-cluster-region>
```

# Civo

```shell
civo kubernetes config <my-cluster> > ~/.kube/config
```

# DigitalOcean

```shell
doctl kubernetes cluster kubeconfig save <my-cluster>
```

# Google Cloud

```shell
gcloud container clusters get-credentials <my-cluster> --region=<my-cluster-region>
```

# Vultr

```shell
vultr-cli kubernetes config my-cluster-id
```

<!--/tabs-->

## Steps for Deprovisioning

Once you have the `kubeconfig` file for your cluster, retrieve the Vault token:

```shell
kubectl -n vault get secrets/vault-unseal-secret --template='{{index .data "root-token"}}' | base64 -d
```

This assumes you've exported the environment variable `KUBECONFIG=/path/to/my/kubeconfig` - if not, you can add `--kubeconfig /path/to/my/kubeconfig` just after `kubectl`.

Once you have the Vault root token, run the following `kubefirst` command to retrieve the required environment variables for deprovisioning:

```shell
kubefirst terraform set-env \
  --vault-token <vault-token> \
  --vault-url https://vault.<your-domain> \
  --output-file .env
source .env
rm .env
```

This will collect the required variables from the necessary secret path and output them to a file referenced by the `--output-file` flag. The second command will set environment variables with its content.

Next, you will need to clone the `gitops` repository generated by kubefirst during the initial cluster creation:

```shell
# GitHub
git clone git@github.com:<my-org>/gitops.git

# GitLab
git clone git@gitlab.com:<my-group>/gitops.git
```

### Terraform

:::danger
If you have added custom resources to the `terraform` section of your `gitops` repository, these resources _will_ show up in the plan. Please exercise caution when destroying, and consult the official [documentation](https://developer.hashicorp.com/terraform/cli/commands/destroy) before proceeding.
:::

Switch to the `terraform` directory inside of the cloned `gitops` repository. For example:

```shell
cd gitops/terraform
```

Within the `terraform` directory, there are several subdirectories that contain the infrastructure-as-code declarations for your kubefirst resources.

#### Cloud Provider

To deprovision the cloud provider resources, switch to the cloud provider subdirectory - for example:

```shell
cd <cloud-folder>
```

You can then use standard `terraform` commands:

```shell
terraform init
terraform destroy
```

Once the last command ran successfully, the cluster including all its resources are fully destroyed.

#### Git

To deprovision the git provider resources, switch to the git provider subdirectory - for example:

```shell
# GitHub
cd ../github

# GitLab
cd ../gitlab
```

You can then use standard `terraform` commands:

```shell
terraform init
terraform destroy
```

Once you've destroyed `terraform` resources for the cloud and git providers, the only resource left to clean up is the state storage objects that kubefirst created on your behalf. If you'd like to remove these, this can be achieved by using the cloud console or the command-line utility for your chosen cloud provider.

You can now delete the `gitops` repository you cloned on your computer.
